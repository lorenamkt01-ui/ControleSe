<div id="login-root">
  <style>
    #login-root .box{max-width:480px;margin:12px auto;padding:16px;border:1px solid var(--line);background:var(--panel);border-radius:14px}
    #login-root h2{margin:0 0 10px 0;font-size:1.1rem}
    #login-root .row{display:flex;gap:10px;align-items:center}
    #login-root .col{display:flex;flex-direction:column;gap:8px}
    #login-root label{font-size:.9rem;color:var(--muted)}
    #login-root input{padding:12px;border-radius:10px;border:1px solid var(--line);background:#0f1116;color:var(--text)}
    #login-root button{padding:12px;border-radius:10px;border:1px solid var(--line);background:#1a1f2a;color:var(--text);cursor:pointer;font-weight:700}
    #login-root .brand{display:flex;gap:10px;align-items:center;margin-bottom:8px}
    #login-root .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg, var(--brand), #16a34a)}
    #login-root .muted{color:var(--muted)}
    #login-root .error{background:#2a1111;border:1px solid #3a1a1a;color:#ffb4b4;padding:10px;border-radius:10px;display:none}
    #login-root .ok{background:#112a18;border:1px solid #1a3a24;color:#b8ffcf;padding:10px;border-radius:10px;display:none}
    #login-root .actions{display:flex;gap:10px;align-items:center}
    #login-root .ghost{background:transparent}
    #login-root .loading{display:none}
    #login-root .spinner{width:18px;height:18px;border:2px solid var(--line);border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>

  <div class="box" role="form" aria-label="Login">
    <div class="brand"><div class="logo" aria-hidden="true"></div><strong>Entrar no Controle$e</strong></div>

    <div id="login-error" class="error" role="alert"></div>
    <div id="login-ok" class="ok" role="status"></div>

    <div class="col" style="margin-top:6px">
      <label for="login-email">E-mail</label>
      <input id="login-email" type="email" placeholder="seu@email.com" autocomplete="email" />
    </div>

    <div class="col" style="margin-top:6px">
      <label for="login-password">Senha</label>
      <div class="row">
        <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" style="flex:1" />
        <button class="ghost" id="btn-toggle-pass" aria-label="Mostrar/ocultar senha" title="Mostrar/ocultar senha">üëÅ</button>
      </div>
    </div>

    <div class="row" style="justify-content:space-between;margin-top:6px">
      <label class="row" style="gap:6px"><input type="checkbox" id="login-remember"/> <span class="muted">Lembrar e-mail</span></label>
      <div class="row loading" id="login-loading"><div class="spinner" aria-hidden="true"></div><span class="muted">Entrando‚Ä¶</span></div>
    </div>

    <div class="actions" style="margin-top:10px">
      <button id="btn-login" onclick="Login.submit()">Entrar</button>
      <button class="ghost" onclick="Login.clear()">Limpar</button>
    </div>

    <p class="muted" style="margin-top:10px;font-size:.85rem">Dica: use os dados da aba <strong>Usuarios</strong> da Planilha de Acessos.</p>
  </div>
</div>

<script>
  // M√≥dulo Login isolado
  const Login = {
    els: {},

    init(){
      const $ = id => document.getElementById(id);
      this.els = {
        email: $('login-email'),
        pass: $('login-password'),
        remember: $('login-remember'),
        err: $('login-error'), ok: $('login-ok'),
        loading: $('login-loading'),
        btnPass: $('btn-toggle-pass')
      };

      // restaurar e-mail salvo
      try {
        const saved = localStorage.getItem('controlese:lastEmail');
        if (saved) { this.els.email.value = saved; this.els.remember.checked = true; }
      } catch(_){}

      // enter para enviar
      [this.els.email, this.els.pass].forEach(el => el.addEventListener('keydown', e=>{
        if (e.key === 'Enter') this.submit();
      }));

      // toggler da senha
      this.els.btnPass.addEventListener('click', (e)=>{
        e.preventDefault();
        const t = this.els.pass.getAttribute('type') === 'password' ? 'text' : 'password';
        this.els.pass.setAttribute('type', t);
      });

      // Expor para parciais que queiram focar
      setTimeout(()=>{ this.els.email?.focus(); }, 50);
    },

    setLoading(on){ this.els.loading.style.display = on ? 'flex' : 'none'; },
    showErr(msg){ this.els.err.textContent = msg || 'Falha no login.'; this.els.err.style.display = 'block'; this.els.ok.style.display = 'none'; },
    showOk(msg){ this.els.ok.textContent = msg || 'Autenticado!'; this.els.ok.style.display = 'block'; this.els.err.style.display = 'none'; },
    clear(){ this.els.email.value=''; this.els.pass.value=''; this.els.err.style.display='none'; this.els.ok.style.display='none'; },

    getCreds(){
      const email = (this.els.email.value||'').trim();
      const senha = (this.els.pass.value||'').trim();
      if (!email || !senha) throw new Error('Informe e-mail e senha.');
      return { email, senha };
    },

    submit(){
      try {
        const { email, senha } = this.getCreds();
        // lembrar email se marcado
        try { if (this.els.remember.checked) localStorage.setItem('controlese:lastEmail', email); else localStorage.removeItem('controlese:lastEmail'); } catch(_){}
        this.setLoading(true);
        this.showErr(''); this.els.err.style.display='none';
        google.script.run
          .withSuccessHandler((res)=>{
            this.setLoading(false);
            if (!res || !res.ok) return this.showErr('N√£o foi poss√≠vel autenticar.');
            this.showOk('Login realizado.');
            try { App.onLoginSuccess(res); } catch(e){ console.error(e); }
          })
          .withFailureHandler((e)=>{
            this.setLoading(false);
            const msg = e && e.message ? e.message : 'Falha no login. Verifique suas credenciais e licen√ßa.';
            this.showErr(msg);
          })
          .login(email, senha);
      } catch(e){ this.showErr(e.message || 'Preencha os campos.'); }
    }
  };

  // Inicializa quando o parcial for injetado
  try { Login.init(); } catch(e){ console.error(e); }
  // Expor globalmente para bot√µes
  window.Login = Login;
</script>
