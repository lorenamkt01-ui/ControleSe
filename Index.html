<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle$e</title>
  <style>
    :root{
      --bg:#0b0c10;--panel:#111318;--line:#1f2430;--text:#eaecef;--muted:#8b93a7;--brand:#22c55e;--danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;z-index:20;background:rgba(11,12,16,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg, var(--brand), #16a34a)}
    .row{display:flex;align-items:center;gap:12px}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:var(--panel);cursor:pointer;font-weight:600}
    .tab[aria-current="page"]{outline:2px solid var(--brand);}
    main{max-width:1100px;margin:0 auto;padding:12px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
    .grid{display:grid;gap:12px}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:900px){.grid-3{grid-template-columns:1fr}}

    /* Filters */
    .filters{position:sticky;top:58px;z-index:10;background:rgba(11,12,16,.9);backdrop-filter:blur(6px);padding:10px;border-bottom:1px solid var(--line)}
    .filters .row{flex-wrap:wrap}
    input,select,button{border-radius:10px;border:1px solid var(--line);background:#0f1116;color:var(--text);padding:10px}
    button{cursor:pointer}
    .right{margin-left:auto}

    /* Sections */
    section[hidden]{display:none !important}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{color:var(--muted);font-weight:600}
    .money{text-align:right;white-space:nowrap}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:900px){.kpi{grid-template-columns:1fr}}
    .money-neg{ color:#C2165E; }      /* negativos */
    .money-pos{ color:#21a782; }      /* positivos */
    .badge-warn{ background:#fdc70c; color:#222; padding:2px 6px; border-radius:8px; font-size:.75rem; }

  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <strong>Controle$e</strong>
      </div>
      <nav class="right" aria-label="Seções">
        <button class="tab" id="tab-dashboard" onclick="App.navigate('dashboard')" aria-current="page">Dashboard</button>
        <button class="tab" id="tab-formulario" onclick="App.navigate('formulario')">Lançar</button>
        <button class="tab" id="tab-calendario" onclick="App.navigate('calendario')">Calendário</button>
        <button class="tab" id="tab-inteligencia" onclick="App.navigate('inteligencia')">Insights</button>
        <button class="tab" id="tab-provisionar" onclick="App.navigate('provisionar')">Provisionar</button>
      </nav>
    </div>
  </header>

  <!-- Filtros Globais -->
  <div class="filters">
    <div class="wrap">
      <div class="row" role="form" aria-label="Filtros">
        <input id="f-data-ini" placeholder="Início (dd/MM/aaaa)" inputmode="numeric"/>
        <input id="f-data-fim" placeholder="Fim (dd/MM/aaaa)" inputmode="numeric"/>
        <select id="f-tipo"><option value="">Tipo</option></select>
        <select id="f-categoria"><option value="">Categoria</option></select>
        <select id="f-subcategoria"><option value="">Subcategoria</option></select>
        <select id="f-forma"><option value="">Forma</option></select>
        <button class="right" onclick="App.refreshAll()">Atualizar</button>
      </div>
    </div>
  </div>

  <main>
    <!-- Painel de Login (incluído) -->
    <section id="sec-login" class="panel"></section>

    <!-- Dashboard (KPIs + Tabela) -->
    <section id="sec-dashboard" class="grid" aria-labelledby="tab-dashboard">
      <div class="kpi" id="kpis"></div>
      <div class="panel">
        <table id="tbl-lanc">
          <thead>
            <tr>
              <th>Data</th><th>Descrição</th><th class="money">Valor</th><th>Tipo</th><th>Categoria</th><th>Subcategoria</th><th>Forma</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Formulário CRUD -->
    <section id="sec-formulario" class="panel" hidden></section>

    <!-- Calendário -->
    <section id="sec-calendario" class="panel" hidden></section>

    <!-- Inteligência Financeira -->
    <section id="sec-inteligencia" class="panel" hidden></section>

    <!-- Provisionar (admin) -->
    <section id="sec-provisionar" class="panel" hidden></section>
  </main>

  <!-- Partials (Apps Script inclui o conteúdo) -->
  <?!= include('Login'); ?>
  <?!= include('Dashboard'); ?>
  <?!= include('Formulario'); ?>
  <?!= include('Calendario'); ?>
  <?!= include('InteligenciaFinanceira'); ?>
  <?!= include('Provisionar'); ?>

  <script>
    // Namespace global
    const App = {
      state: { token: null, timer: null, ws: null, lastFilters: {} },

      // Navegação entre seções
      navigate(section){
        const sections = ['dashboard','formulario','calendario','inteligencia','provisionar'];
        sections.forEach(id=>{
          const sec = document.getElementById('sec-'+id);
          const tab = document.getElementById('tab-'+id);
          if(!sec || !tab) return;
          const on = (id===section);
          sec.hidden = !on;
          tab.setAttribute('aria-current', on ? 'page' : 'false');
        });
        if (section==='dashboard') this.refreshAll();
      },

      // API de login para o partial Login.html chamar
      onLoginSuccess(auth){
        this.state.token = auth.token;
        this.loadFilterOptions();
        this.attachRealtime();
        this.refreshAll();
        // Esconde painel de login após logar
        const secLogin = document.getElementById('sec-login');
        secLogin.hidden = true;
      },

      // Caso precise exibir novamente o login
      showLogin(){ document.getElementById('sec-login').hidden = false; },

      ensureToken(){
        if(!this.state.token){
          alert('Por favor, faça login para continuar.');
          this.showLogin();
          throw new Error('Sem token');
        }
      },

      // Filtros (get/set)
      getFilters(){
        const val = id => (document.getElementById(id)?.value || '').trim();
        return {
          dataIni: val('f-data-ini'),
          dataFim: val('f-data-fim'),
          tipo: val('f-tipo'),
          categoria: val('f-categoria'),
          subcategoria: val('f-subcategoria'),
          forma: val('f-forma'),
          page: 1,
          pageSize: 200
        };
      },

      applyFilterOptions(opts){
        const fill = (id, items)=>{
          const el = document.getElementById(id);
          if(!el) return;
          const sel = el.value; // preserva seleção atual
          el.innerHTML = '<option value=""></option>' + items.map(v=>`<option>${String(v)}</option>`).join('');
          if (Array.from(el.options).some(o=>o.value===sel)) el.value = sel;
        };
        fill('f-tipo', opts.tipos||[]);
        fill('f-categoria', opts.categorias||[]);
        fill('f-subcategoria', opts.subcategorias||[]);
        fill('f-forma', opts.formas||[]);
      },

      loadFilterOptions(){
        this.ensureToken();
        google.script.run.withSuccessHandler(opts=>{
          try{ this.applyFilterOptions(opts); }catch(e){console.error(e)}
        }).withFailureHandler(e=>console.error(e)).getFilterOptions(this.state.token);
      },

      // Atualizações (metrics + list)
      refreshAll(){
        this.ensureToken();
        const f = this.getFilters();
        this.state.lastFilters = f;
        google.script.run.withSuccessHandler(m=>{
          this.drawKpis(m);
        }).withFailureHandler(this._fail).getMetrics(this.state.token, f);

        google.script.run.withSuccessHandler(res=>{
          this.drawTable(res);
        }).withFailureHandler(this._fail).listLancamentos(this.state.token, f);
      },
    drawKpis(m){
      const el = document.getElementById('kpis');
      const card = (label, val, cls)=>`
        <div class="panel">
          <div>${label}</div>
          <div style="font-size:1.4rem;font-weight:700" class="${cls}">
            ${this.fmtMoney(val)}
          </div>
          <div style="color:var(--muted);font-size:.9rem">
            Atualizado: ${new Date(m.ts).toLocaleString('pt-BR')}
          </div>
        </div>`;
      el.innerHTML = 
        card('Entradas', m.entradas, 'money-pos') +
        card('Saídas',   m.saidas,   'money-neg') +
        card('Saldo',    m.saldo,    (m.saldo>=0?'money-pos':'money-neg'));
    },

    drawTable(res){
      // Se a sua tabela no HTML tiver id "tbl", troque a linha abaixo para '#tbl tbody'
      const tb = document.querySelector('#tbl-lanc tbody'); 
      tb.innerHTML = '';

      // helpers
      const parseBR = (s)=>{
        const m = String(s||'').match(/(\d{2})\/(\d{2})\/(\d{4})/);
        return m ? new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1])) : null;
      };
      const today = new Date(); today.setHours(0,0,0,0);

      for(const it of res.items){
        const tr = document.createElement('tr');

        const tipo = String(it.tipo||'');
        const isSaida = ['saída','saida'].includes(tipo.toLowerCase());
        const clsValor = isSaida ? 'money-neg' : 'money-pos';

        const d = parseBR(it.data);
        const vencido = isSaida && !it.status && d && d < today;

        tr.innerHTML = `
          <td>
            ${it.data||''}
            ${vencido ? '<span class="badge-warn" style="margin-left:6px">vencido</span>' : ''}
          </td>
          <td>${this.escape(it.descricao||'')}</td>
          <td class="money ${clsValor}">
            ${this.fmtMoney(it.valor)}
          </td>
          <td>${this.escape(tipo)}</td>
          <td>${this.escape(it.categoria||'')}</td>
          <td>${this.escape(it.subcategoria||'')}</td>
          <td>${this.escape(it.forma||'')}</td>
        `;
        tb.appendChild(tr);
      }
    },


      startPolling(){
        if (this.state.timer) clearInterval(this.state.timer);
        this.state.timer = setInterval(()=>this.refreshAll(), 30000);
      },

      // Utils
      debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), ms); } },
      fmtMoney(n){ try { return Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) } catch(_) { return n } },
      escape(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') },
      _fail(e){ console.error(e); alert(e && e.message ? e.message : 'Erro na operação.'); }
    };

    // Expor no escopo global
    window.App = App;

    // Debounce dos filtros
    const bindFilter = (id, evt='input', wait=400)=>{
      const el = document.getElementById(id); if(!el) return;
      el.addEventListener(evt, App.debounce(()=>App.refreshAll(), wait));
    };
    ['f-data-ini','f-data-fim','f-tipo','f-categoria','f-subcategoria','f-forma'].forEach(id=>{
      bindFilter(id,'input',400); bindFilter(id,'change',0);
    });

    // Carrega conteúdo dos parciais no placeholders
    // Cada parcial deve preencher seu container ao ser incluído (ver Login.html etc.)
    document.getElementById('sec-login').innerHTML = `<?!= include('Login') ?>`;
    document.getElementById('sec-formulario').innerHTML = `<?!= include('Formulario') ?>`;
    document.getElementById('sec-calendario').innerHTML = `<?!= include('Calendario') ?>`;
    document.getElementById('sec-inteligencia').innerHTML = `<?!= include('InteligenciaFinanceira') ?>`;
    document.getElementById('sec-provisionar').innerHTML = `<?!= include('Provisionar') ?>`;

    // Padrão ao abrir
    App.navigate('dashboard');
  </script>
</body>
</html>
